name: CI — Build & Integration Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PANEL_PORT: 39921

jobs:
  # ============================================================
  # Job 1: Build everything (Go binary + Frontend dist)
  # ============================================================
  build:
    name: Build & Unit Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      # --- Go ---
      - name: Go — Vet
        run: go vet ./...

      - name: Go — Unit tests
        run: go test ./... -v -count=1

      # --- Frontend ---
      - name: Frontend — Install & Build
        working-directory: web
        run: |
          npm ci
          npm run build

      # --- Go binary (with frontend built) ---
      - name: Go — Build binary
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          CGO_ENABLED=1 go build -ldflags="-s -w -X main.Version=${VERSION}" -o caddypanel .
          echo "✅ Binary built"

      # --- Upload for integration job ---
      - name: Upload binary + frontend
        uses: actions/upload-artifact@v4
        with:
          name: caddypanel-build
          path: |
            caddypanel
            web/dist/
          retention-days: 1

  # ============================================================
  # Job 2: Integration Test (no Go, no Node.js needed)
  # Downloads pre-built binary + dist from Job 1
  # ============================================================
  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      # --- Download pre-built artifacts from build job ---
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: caddypanel-build

      - name: Prepare binary
        run: chmod +x caddypanel

      # --- Install Caddy only (via official repo) ---
      - name: Install Caddy
        run: |
          sudo apt-get install -y debian-keyring debian-archive-keyring apt-transport-https > /dev/null 2>&1
          curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg 2>/dev/null
          curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list > /dev/null
          sudo apt-get update -qq
          sudo apt-get install -y caddy > /dev/null
          caddy version
          sudo systemctl stop caddy
          sudo systemctl disable caddy

      # --- Setup directories & start panel ---
      - name: Setup and start CaddyPanel
        run: |
          mkdir -p data/logs data/backups
          export CADDYPANEL_PORT=$PANEL_PORT
          export CADDYPANEL_JWT_SECRET=ci-test-secret-not-for-production
          export CADDYPANEL_CADDY_BIN=$(which caddy)
          export CADDYPANEL_DATA_DIR=./data
          export CADDYPANEL_LOG_DIR=./data/logs
          export GIN_MODE=release
          ./caddypanel > /tmp/caddypanel.log 2>&1 &
          echo $! > /tmp/caddypanel.pid
          echo "PID: $(cat /tmp/caddypanel.pid)"

          # Wait for API to be ready
          echo "Waiting for API..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:$PANEL_PORT/api/auth/need-setup > /dev/null 2>&1; then
              echo "✅ API ready after ${i}s"
              break
            fi
            sleep 1
          done

          # Check if still running
          if ! kill -0 $(cat /tmp/caddypanel.pid) 2>/dev/null; then
            echo "❌ CaddyPanel process died!"
            cat /tmp/caddypanel.log
            exit 1
          fi

          # Debug: show need-setup response
          echo "=== need-setup response ==="
          curl -s http://localhost:$PANEL_PORT/api/auth/need-setup | jq .

      # ==================== API Tests ====================

      - name: 'Test: Create admin account'
        run: |
          HTTP_CODE=$(curl -s -o /tmp/setup_response.json -w "%{http_code}" \
            -X POST http://localhost:$PANEL_PORT/api/auth/setup \
            -H 'Content-Type: application/json' \
            -d '{"username":"admin","password":"testpassword123"}')
          echo "HTTP $HTTP_CODE"
          cat /tmp/setup_response.json | jq .
          [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ] || exit 1
          echo "✅ Admin setup succeeded"

      - name: 'Test: Login'
        run: |
          # First, get an ALTCHA challenge
          CHALLENGE_JSON=$(curl -sf http://localhost:$PANEL_PORT/api/auth/altcha-challenge)
          echo "Challenge received: $CHALLENGE_JSON"

          # Extract fields
          CHALLENGE=$(echo "$CHALLENGE_JSON" | jq -r '.challenge')
          SALT=$(echo "$CHALLENGE_JSON" | jq -r '.salt')
          ALGORITHM=$(echo "$CHALLENGE_JSON" | jq -r '.algorithm')
          SIGNATURE=$(echo "$CHALLENGE_JSON" | jq -r '.signature')

          # Solve PoW using Node.js (available in CI environment)
          NUMBER=$(SALT="$SALT" CHALLENGE="$CHALLENGE" node -e "
            const crypto = require('crypto');
            const salt = process.env.SALT;
            const challenge = process.env.CHALLENGE;
            for(let i=0; i<=50000; i++) {
              if(crypto.createHash('sha256').update(salt + i).digest('hex') === challenge) {
                console.log(i);
                process.exit(0);
              }
            }
          ")
          echo "Solved PoW: $NUMBER"

          # Construct payload and base64 encode
          PAYLOAD_JSON=$(jq -n \
            --arg alg "$ALGORITHM" \
            --arg chal "$CHALLENGE" \
            --argjson num "$NUMBER" \
            --arg salt "$SALT" \
            --arg sig "$SIGNATURE" \
            '{algorithm: $alg, challenge: $chal, number: $num, salt: $salt, signature: $sig}')
          ALTCHA_B64=$(echo -n "$PAYLOAD_JSON" | base64 -w 0)

          RESPONSE=$(curl -sf -X POST http://localhost:$PANEL_PORT/api/auth/login \
            -H 'Content-Type: application/json' \
            -d "{\"username\":\"admin\",\"password\":\"testpassword123\",\"altcha\":\"$ALTCHA_B64\"}")
          TOKEN=$(echo "$RESPONSE" | jq -r '.token')
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "✅ Login succeeded"

      - name: 'Test: Create proxy host'
        run: |
          RESPONSE=$(curl -sf -X POST http://localhost:$PANEL_PORT/api/hosts \
            -H "Authorization: Bearer $TOKEN" \
            -H 'Content-Type: application/json' \
            -d '{
              "domain": "localhost:8888",
              "tls_enabled": false,
              "http_redirect": false,
              "websocket": false,
              "upstreams": [{"address": "localhost:9999"}]
            }')
          HOST_ID=$(echo "$RESPONSE" | jq -r '.id')
          echo "HOST_ID=$HOST_ID" >> $GITHUB_ENV
          echo "✅ Host created (ID: $HOST_ID)"

      - name: 'Test: List hosts'
        run: |
          COUNT=$(curl -sf http://localhost:$PANEL_PORT/api/hosts \
            -H "Authorization: Bearer $TOKEN" | jq '.total')
          [ "$COUNT" -ge 1 ] || exit 1
          echo "✅ Host list OK (total: $COUNT)"

      - name: 'Test: Caddyfile generated correctly'
        run: |
          CONTENT=$(curl -sf http://localhost:$PANEL_PORT/api/caddy/caddyfile \
            -H "Authorization: Bearer $TOKEN" | jq -r '.content')
          echo "$CONTENT"
          echo "$CONTENT" | grep -q "localhost:8888" || exit 1
          echo "$CONTENT" | grep -q "reverse_proxy" || exit 1
          echo "✅ Caddyfile contains host config"

      - name: 'Test: Caddy validates Caddyfile'
        run: |
          caddy validate --config data/Caddyfile
          echo "✅ caddy validate passed"

      - name: 'Test: Start Caddy via API'
        run: |
          HTTP_CODE=$(curl -s -o /tmp/caddy_start.json -w "%{http_code}" \
            -X POST http://localhost:$PANEL_PORT/api/caddy/start \
            -H "Authorization: Bearer $TOKEN")
          echo "HTTP $HTTP_CODE"
          cat /tmp/caddy_start.json | jq . 2>/dev/null || cat /tmp/caddy_start.json
          if [ "$HTTP_CODE" != "200" ]; then
            echo "⚠️  Caddy start returned $HTTP_CODE — may not work in CI"
            echo "CADDY_RUNNING=false" >> $GITHUB_ENV
          else
            sleep 2
            echo "CADDY_RUNNING=true" >> $GITHUB_ENV
            echo "✅ Caddy started"
          fi

      - name: 'Test: Caddy is running'
        if: env.CADDY_RUNNING == 'true'
        run: |
          curl -sf http://localhost:$PANEL_PORT/api/caddy/status \
            -H "Authorization: Bearer $TOKEN" | jq -e '.running == true' > /dev/null
          echo "✅ Caddy is running"

      - name: 'Test: Reload Caddy'
        if: env.CADDY_RUNNING == 'true'
        run: |
          curl -sf -X POST http://localhost:$PANEL_PORT/api/caddy/reload \
            -H "Authorization: Bearer $TOKEN" | jq .
          echo "✅ Caddy reloaded"

      - name: 'Test: Toggle host off → removed from Caddyfile'
        run: |
          curl -sf -X PATCH "http://localhost:$PANEL_PORT/api/hosts/$HOST_ID/toggle" \
            -H "Authorization: Bearer $TOKEN" > /dev/null

          CONTENT=$(curl -sf http://localhost:$PANEL_PORT/api/caddy/caddyfile \
            -H "Authorization: Bearer $TOKEN" | jq -r '.content')
          if echo "$CONTENT" | grep -q "localhost:8888"; then
            echo "❌ Disabled host should not be in Caddyfile"; exit 1
          fi
          echo "✅ Host disabled — removed from Caddyfile"

          curl -sf -X PATCH "http://localhost:$PANEL_PORT/api/hosts/$HOST_ID/toggle" \
            -H "Authorization: Bearer $TOKEN" > /dev/null
          echo "✅ Host re-enabled"

      - name: 'Test: Export config'
        run: |
          curl -sf http://localhost:$PANEL_PORT/api/config/export \
            -H "Authorization: Bearer $TOKEN" | jq '.hosts | length'
          echo "✅ Config export OK"

      - name: 'Test: Delete host'
        run: |
          curl -sf -X DELETE "http://localhost:$PANEL_PORT/api/hosts/$HOST_ID" \
            -H "Authorization: Bearer $TOKEN" > /dev/null
          COUNT=$(curl -sf http://localhost:$PANEL_PORT/api/hosts \
            -H "Authorization: Bearer $TOKEN" | jq '.total')
          [ "$COUNT" -eq 0 ] || exit 1
          echo "✅ Host deleted, list empty"

      - name: 'Test: Stop Caddy'
        if: env.CADDY_RUNNING == 'true'
        run: |
          curl -sf -X POST http://localhost:$PANEL_PORT/api/caddy/stop \
            -H "Authorization: Bearer $TOKEN" > /dev/null
          sleep 1
          STATUS=$(curl -sf http://localhost:$PANEL_PORT/api/caddy/status \
            -H "Authorization: Bearer $TOKEN" | jq -r '.running')
          [ "$STATUS" = "false" ] || exit 1
          echo "✅ Caddy stopped"

      # --- Diagnostics on failure ---
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== CaddyPanel process log ==="
          cat /tmp/caddypanel.log 2>/dev/null || echo "No log file"
          echo ""
          echo "=== Caddyfile ==="
          cat data/Caddyfile 2>/dev/null || echo "Not found"
          echo ""
          echo "=== API setup response ==="
          cat /tmp/setup_response.json 2>/dev/null || echo "No response file"
          echo ""
          echo "=== Data directory ==="
          ls -la data/ 2>/dev/null || echo "No data dir"

      - name: Cleanup
        if: always()
        run: |
          kill $(cat /tmp/caddypanel.pid) 2>/dev/null || true
          caddy stop 2>/dev/null || true
